<h2 align="center">
Debezium Command and Usage Documentation
</h2>

Following url for document

https://royalihasan.medium.com/integrating-oracle-database-with-debezium-and-kafka-connect-for-cdc-change-data-capture-f44d758e7f69

https://gist.github.com/sujeet100/7f10b10db0c655ebe9e56abfc99a929a

Step 1:Login to the Oracle Container Registry:

Run the following command to log in to the Oracle Container Registry. You will be prompted to enter your Oracle Cloud credentials (username and password):


```bash
docker login container-registry.oracle.com

username: dmahfuzd@gmail.com
password: *Dd912770d*@
```

Step 2:Pull the Oracle Image:
```bash
docker pull container-registry.oracle.com/database/enterprise:latest
```

Docker Compose File

```bash
version: '3.8'
services:
  zookeeper:
    image: confluentinc/cp-zookeeper:latest
    container_name: zookeeper
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000

  kafka:
    image: confluentinc/cp-kafka:latest
    container_name: kafka
    depends_on:
      - zookeeper
    ports:
      - 9092:9092
    environment:
      KAFKA_ZOOKEEPER_CONNECT: "zookeeper:2181"
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092
      KAFKA_BROKER_ID: 1
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: "true"
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 1
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 1
      KAFKA_GROUP_INITIAL_REBALANCE_DELAY_MS: 100

  schema-registry:
    image: confluentinc/cp-schema-registry:5.5.3
    container_name: schema-registry
    ports:
      - 8081:8081
    depends_on:
      - zookeeper
      - kafka
    environment:
      SCHEMA_REGISTRY_HOST_NAME: schema-registry
      SCHEMA_REGISTRY_KAFKASTORE_CONNECTION_URL: zookeeper:2181
  debezium:
    image: debezium/connect:1.9
    container_name: connect
    environment:
      BOOTSTRAP_SERVERS: kafka:9092
      GROUP_ID: 1
      CONFIG_STORAGE_TOPIC: connect_configs
      OFFSET_STORAGE_TOPIC: connect_offsets
      CONNECT_CONFIG_STORAGE_REPLICATION_FACTOR: "1"
      CONNECT_OFFSET_STORAGE_REPLICATION_FACTOR: "1"
      CONNECT_STATUS_STORAGE_REPLICATION_FACTOR: "1"
      KEY_CONVERTER: io.confluent.connect.avro.AvroConverter
      VALUE_CONVERTER: io.confluent.connect.avro.AvroConverter
      CONNECT_KEY_CONVERTER_SCHEMA_REGISTRY_URL: http://schema-registry:8081
      CONNECT_VALUE_CONVERTER_SCHEMA_REGISTRY_URL: http://schema-registry:8081
      LD_LIBRARY_PATH: '/kafka/external_libs/instantclient_19_6/'
    depends_on: [ kafka , zookeeper,schema-registry ]
    ports:
      - 8083:8083

  kafka_manager:
    image: hlebalbau/kafka-manager:stable        
    container_name: kafka-manager
    restart: always
    ports:
      - "9000:9000"
    depends_on:
      - zookeeper
      - kafka
    environment:
      ZK_HOSTS: "zookeeper:2181"
      APPLICATION_SECRET: "random-secret"
      command: -Dpidfile.path=/dev/null

  # Source DB's
  oracle:
    image: container-registry.oracle.com/database/enterprise:latest # 21C
    container_name: oracle
    environment:
      - ORACLE_PWD=top_secret
    ports:
      - 1521:1521


  # Sinks DB's
  postgres:
    # *-----------------------------*
    # To connect to the DB:
    #   docker exec -it postgres bash -c 'psql -U $POSTGRES_USER $POSTGRES_DB'
    # *-----------------------------*
    image: postgres:latest
    container_name: postgres
    environment:
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=postgres
    ports:
      - 5432:5432
```


### 1. Prepare a Database for the CDC
Step 1: Create a recovery area folder
Now you need to access the Oracle bash shell


```bash
docker exec -it oracle bash -c 'sleep 1;
```
Create a recovery_area Directory

```bash
cd /opt/oracle/oradata
mkdir -p recovery_area
```

Step2: Setup the Logminer in Oracle Database
Following script download to host machine

```bash
cd /data/oracle-debezium/oracle/logminer

wget https://raw.githubusercontent.com/royalihasan/dockerized-setup-kafka-connect-oracle-debezium-stack/master/src/main/resources/01_db_setup_scripts/01_logminer-setup.sh

chmod +x ./01_logminer-setup.sh
```

Copy logminer script to oracle container any directory to run logminer

```bash
# Copy logminer script
sudo docker cp /data/oracle-debezium/oracle/logminer/01_logminer-setup.sh oracle:/tmp

# Access oracle database
docker exec -it oracle bash

# cd where the file copy
cd /tmp

# run the logminer script
./01_logminer-setup.sh
```


Step3: Create a Sample database for testing purpuse

Oracle developer:

```bash
Username: debezium
Password: dbz
Role: default
Hostname: 172.23.190.23
Port: 1521
Service Name: orclpdb1
```

Then create following table

```sql
CREATE TABLE custmers (
    customer_id NUMBER GENERATED BY DEFAULT AS IDENTITY,
    first_name VARCHAR2(50),
    last_name VARCHAR2(50),
    email VARCHAR2(100),
    buy_date DATE,
    product VARCHAR2(50),
    price NUMBER(10, 2),
    PRIMARY KEY (customer_id)
);
```
Create the second table. For example, creating a departments table:

```sql
CREATE TABLE products (
    product_id NUMBER GENERATED BY DEFAULT AS IDENTITY,
    product_name VARCHAR2(100),
    PRIMARY KEY (product_id)
);
```


SQL Plus:

```bash
docker exec -it oracle bash

curl https://raw.githubusercontent.com/royalihasan/dockerized-setup-kafka-connect-oracle-debezium-stack/master/src/main/resources/01_db_setup_scripts/inventory.sql | sqlplus debezium/dbz@//localhost:1521/orclpdb1
```

Step 4: Confirm that the tables were created successfully.
a. Start sqlplus prompt
```bash
docker exec -it oracle bash -c 'sleep 1; sqlplus Debezium/dbz@localhost:1521/orclpdb1'
```

b. USE Select Statement on Tables we created
```bash
SELECT *
FROM CUSTOMERS;
```

### Prepare Debizium Connect for CDC
Step1: Install the Required Drivers

Now need download ojdbc driver in host machine
```bash
wget https://download.oracle.com/otn-pub/otn_software/jdbc/235/ojdbc8.jar
```

Copy ojdbc driver host machine to debezium container following path
```bash
sudo docker cp /data/oracle-debezium/oracle/ojdbc-driver/ojdbc8.jar connect:/kafka/libs
```

Need to access the bash terminal of Debezium container
```bash
# Access debezium container
sudo docker exec -it connect /bin/bash

# Check ojdbc driver have in /kafka/libs directory from debezium container
ls
```

Restart the debezium container
```bash
sudo docker restart connect
```

3. Create a Oracle Source Connector for Testing

Generate a POST request on: http://localhost:8083/connectors

Avro format

```bash
{
  "name": "oracle-customer-source-connector-00",
  "config": {
    "connector.class": "io.debezium.connector.oracle.OracleConnector",
    "database.hostname": "172.23.190.52",
    "database.port": "1521",
    "database.user": "c##dbzuser",
    "database.password": "dbz",
    "database.server.name": "test",
    "database.history.kafka.topic": "history",
    "database.dbname": "ORCLCDB",
    "database.connection.adapter": "LogMiner",
    "database.history.kafka.bootstrap.servers": "172.23.211.31:9092,172.23.211.32:9092,172.23.211.33:9092",
    "table.include.list": "DEBEZIUM.CUSTOMERS",
    "database.schema": "DEBEZIUM",
    "database.pdb.name": "ORCLPDB1",
    "snapshot.mode": "schema_only",
    "include.schema.changes": "true",
    "key.converter": "io.confluent.connect.avro.AvroConverter",
    "value.converter": "io.confluent.connect.avro.AvroConverter",
    "key.converter.schema.registry.url": "http://172.23.190.52:8081",
    "value.converter.schema.registry.url": "http://172.23.190.52:8081"
  }
}
```
JSON Format
```bash
{
    "name": "oracle-customers-source-connector-00",
    "config": {
        "connector.class": "io.debezium.connector.oracle.OracleConnector",
        "database.hostname": "172.23.190.52",
        "database.port": "1521",
        "database.user": "c##dbzuser",
        "database.password": "dbz",
        "database.server.name": "test",
        "database.history.kafka.topic": "history",
        "database.dbname": "ORCLCDB",
        "database.connection.adapter": "LogMiner",
        "database.history.kafka.bootstrap.servers": "172.23.211.31:9092,172.23.211.32:9092,172.23.211.33:9092",
        "table.include.list": "DEBEZIUM.CUSTOMER,DEBEZIUM.PRODUCTS,",
        "database.schema": "DEBEZIUM",
        "database.pdb.name": "ORCLPDB1",
        "snapshot.mode": "schema_only",
        "include.schema.changes": "true",
        "key.converter": "org.apache.kafka.connect.json.JsonConverter",
        "value.converter": "org.apache.kafka.connect.json.JsonConverter",
        "key.converter.schemas.enable": "false",
        "value.converter.schemas.enable": "false"
    }
}
```




Now check the Connector is Working Fine

By Using this in you BASH
```bash
curl -s "http://172.23.190.52:8083/connectors?expand=info&expand=status" | \
jq '. | to_entries[] | [ .value.info.type, .key, .value.status.connector.state,.value.status.tasks[].state,.value.info.config."connector.class"]|join(":|:")' | \
column -s : -t| sed 's/\"//g'| sort
```

The Output Should be like this
```bash
source | oracle-customer-source-connector-00 | RUNNING | RUNNING | io.debezium.connector.oracle.OracleConnector
```


Step2: Listen to the Topic and Read Message messages

Access You Terminal and paste this command
```bash
docker run --tty --network resources_default confluentinc/cp-kafkacat kafkacat -b kafka:9092 -C -s key=s -s value=avro -r http:/schema-registry:8081 -t test.DEBEZIUM.CUSTOMERS
```


Check connetors list

```bash
curl http://localhost:8083/connectors

["oracle-customer-source-connector-00","oracle-customer-source-connector-01"]
```

Check connector status
```bash
curl http://localhost:8083/connectors/oracle-customer-source-connector-00/status

{"name":"oracle-customer-source-connector-00","connector":{"state":"RUNNING","worker_id":"172.28.0.8:8083"},"tasks":[{"id":0,"state":"RUNNING","worker_id":"172.28.0.8:8083"}],"type":"source"}
```

Connector delete
```bash
curl -X DELETE http://localhost:8083/connectors/oracle-customer-source-connector-00
```